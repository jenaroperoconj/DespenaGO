
<ion-content class="ion-padding">
  <h2>Escanear Boleta</h2>
  <ion-button expand="block" (click)="takePicture()">Tomar Foto</ion-button>
  <ion-button expand="block" color="medium" (click)="resetOCR()" *ngIf="image || ocrText || productosFiltrados.length > 0">Escanear otra boleta</ion-button>
  
  <div *ngIf="image" class="image-container">
    <img [src]="image" alt="Boleta" class="boleta-image" />
    <ion-button expand="block" color="success" (click)="processOCR()" [disabled]="loading">
      <ion-spinner *ngIf="loading" name="dots"></ion-spinner>
      <span *ngIf="!loading">Procesar OCR</span>
    </ion-button>
  </div>

  <div *ngIf="ocrText && !loading" class="texto-extraido">
    <h3>Texto extraído:</h3>
    <ion-textarea [value]="ocrText" readonly autoGrow="true"></ion-textarea>
  </div>

  <div *ngIf="precisionGlobal !== null" class="precision-global">
    <ion-chip color="tertiary">
      <ion-label>Precisión del sistema: {{ precisionGlobal }}%</ion-label>
    </ion-chip>
  </div>

  <div *ngIf="productosFiltrados.length > 0" class="productos-detectados">
    <h3>Productos Alimenticios Detectados:</h3>
    <ion-list>
      <ion-item *ngFor="let producto of productosFiltrados; let i = index">
        <ion-label>
          <h2>{{ producto.nombre }}</h2>
          <p class="nombre-original">Original: {{ producto.nombreOriginal }}</p>
          <div class="categorias-container">
            <ion-chip color="primary">
              <ion-icon [name]="getIconoCategoria(producto.categoria)"></ion-icon>
              <ion-label>{{ producto.categoria | titlecase }}</ion-label>
            </ion-chip>
            <ion-chip [color]="producto.confianza >= 5 ? 'success' : producto.confianza >= 3 ? 'warning' : 'danger'">
              <ion-label>Confianza: {{ getNivelConfianza(producto.confianza) }}</ion-label>
            </ion-chip>
          </div>
        </ion-label>
      </ion-item>
    </ion-list>
    <ion-button expand="block" color="primary" (click)="aceptarSeleccionados()">Confirmar productos detectados</ion-button>
  </div>

  <ion-toast
    [isOpen]="mostrarToast"
    [message]="mensajeToast"
    [duration]="3000"
    (didDismiss)="mostrarToast = false"
    position="bottom">
  </ion-toast>
</ion-content>

<style>
.image-container {
  margin: 16px 0;
}

.boleta-image {
  width: 100%;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.texto-extraido {
  margin: 16px 0;
  padding: 16px;
  background: #f5f5f5;
  border-radius: 8px;
}

.productos-detectados {
  margin: 16px 0;
}

.nombre-original {
  color: #666;
  font-size: 0.9em;
  margin: 4px 0;
}

.categorias-container {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}

ion-chip {
  margin: 4px;
}
</style>
